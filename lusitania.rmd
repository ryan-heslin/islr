```{r}
library(tidyverse)
library(here)
lusi_raw <- read_csv(file = "data/LusitaniaManifest.csv")
glimpse(lusi_raw)
```
I start by making tables of relevant variables. Several variables have classes with just a few members: there were a handful of separated but not divorced passengers, and apparently three stoways. I'll probably want to condense these factors. We can also see that the most common crew positions were fireman (attending the steam boilers) and trimmer (responsible for coal handling), followed by waiters. Most passengers came from the US East Coast, as we'd expect from a westward voyage.

I create a new factor representing whther a passenger was rescued by a rescue vessel, a lifeboat, both, or neither.

The survival rate was about 39%, so a naive classifier would get 61% accuracy by predicting death for everyone aboard.
```{r}
lusi_cleaned <- lusi_raw %>% rename("row" = "X1")  %>% 
  mutate(Rescue = case_when(Fate == "Lost" ~ "Died",
                            !is.na(`Rescue Vessel`) &! is.na(Lifeboat) ~ "Both",
                            !is.na(`Rescue Vessel`)  ~ "RV",
                            !is.na(Lifeboat) ~ "Lifeboat",
                            TRUE ~ "Neither") %>%
           factor(),
         row = row + 1)

map(lusi_cleaned[, -(1:4)], table) %>% 
  map(sort, decreasing = TRUE)

survival<- mean(lusi_cleaned$Fate == "Saved")
```
Checking NA's, it seems we ahave complete data on sex and adult/minor status, but many marital statuses and origin cities are missing. There are a few mising personal names, too.

It turns out these were three German stowaways with unknown names! They refused to answer questions when apprehended, and may have been German spies. None survived.
See: https://www.rmslusitania.info/people/stowaways/

```{r}
lusi_cleaned %>% map_dbl(~mean(is.na(.x))) %>% 
  enframe( name = "Variable")

lusi_cleaned %>% filter(is.na(`Personal name`))
```

I grpah the categorical variables. The purrr family makes this kind of automatic plotting quite easy. We see some obvious patterns: passengers are overwhlemingly male and adult. Few survivors were picked up by lifeboats or a rescue vessel; since the _Lusitania_ went down off the Irish coast, failing to get a lifeboat wasn't a virtual death sentence as on _Titanic._

```{r}

lusi_cleaned <- lusi_cleaned %>% mutate(across(c(Title, Fate, `Department/Class`, `Passenger/Crew`, Citizenship, Status, `Adult/Minor`, Sex),
                                               ~fct_explicit_na(.x) %>%
                                                 fct_infreq(.) %>% 
                                                 fct_lump_prop(., prop = .1)))
lusi_cleaned %>% select(where(is.factor)) %>% 
  imap( ~ggplot(data = lusi_cleaned, aes(x = !!sym(.y), fill = !!sym(.y)))+
          geom_bar()+
          scale_fill_brewer(palette = "Spectral") +
          labs(title = .y, y = "Count"))
```
Age distribution looks roughly normal, with the mean around 30 and a slight bulge below 20
```{r}
lusi_cleaned %>% ggplot(aes(x = Age, fill = "red"))+
  geom_histogram(stat = "count", bins = n_distinct(lusi_cleaned$Age)) +
  theme(legend.position = "none")
```
I don't have data on people who traveled as families, but I see if I can infer it by comparing surnames. Several of the unaccompanied minors were crew

```{r}
lusi_cleaned %>% group_by(`Family name`) %>% 
  filter(n() ==1, min(Age) <18) 
families <- lusi_cleaned %>% 
  group_by(`Family name`) %>% 
  filter(n() >1, min(Age) <18) %>% 
  mutate(Family = factor(levels = ifelse()))


```
Interestingly, the survival rate is almost identical for the six combinations of sex and class.
```{r}
lusi_cleaned %>% 
  filter(`Passenger/Crew` == "Passenger") %>% 
  group_by(Sex, `Department/Class`) %>% 
  summarize(Survived = mean(Fate == "Saved"), Died = 1- Survived) %>% 
  pivot_longer(c(Survived, Died), names_to = "Fate") %>% 
  ggplot(aes(x = Fate, y = value, fill = Fate))+
  geom_col()+
  scale_y_continuous(labels = scales::percent_format()) +
  facet_grid(`Department/Class` ~ Sex, scales = "free_y") +
  labs(y = "Survival Rate", title = 'Survival by Sex and Class' )
```

```{r}
lusi %>% 
```

